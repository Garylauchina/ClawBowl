# Nginx 反向代理配置 - 微信小程序 -> OpenClaw Gateway
# 
# 状态：已部署到服务器 ✓
# 配置文件位置：/etc/nginx/sites-enabled/openclaw
# 部署时间：2026-02-13
#
# 已在服务器上完成的操作：
# 1. 启用 OpenClaw HTTP API 端点：
#    openclaw config set gateway.http.endpoints.chatCompletions.enabled true
#    openclaw config set gateway.http.endpoints.responses.enabled true
#    openclaw daemon restart
# 2. 在 Nginx 配置中添加 /api/chat location 块
# 3. nginx -t && nginx -s reload
#
# 端到端测试通过：
#   curl -X POST https://prometheusclothing.net/api/chat \
#     -H 'Content-Type: application/json' \
#     -d '{"model":"openclaw:main","messages":[{"role":"user","content":"hi"}]}'

# 以下为实际部署在服务器上的 location 块（位于 server { ... } 内）

# 隐私政策页面（App Store 必需）
location /privacy-policy {
    alias /var/www/clawbowl/privacy-policy.html;
    default_type text/html;
}

# 技术支持页面（App Store 必需）
location /support {
    alias /var/www/clawbowl/support.html;
    default_type text/html;
}

location /api/chat {
    # 仅允许 POST 请求
    if ($request_method != POST) {
        return 405;
    }

    # 转发到 OpenClaw Gateway（端口 18789）
    proxy_pass http://127.0.0.1:18789/v1/chat/completions;
    proxy_http_version 1.1;

    # 自动注入认证头（客户端无需携带 token）
    proxy_set_header Authorization "Bearer <token-on-server>";
    proxy_set_header Content-Type "application/json";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 超时设置（AI 回复可能需要较长时间）
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # 请求体大小限制
    client_max_body_size 1m;
}
