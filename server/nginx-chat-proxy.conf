# Nginx 反向代理配置 - ClawBowl Multi-tenant Architecture
# 
# 配置文件位置：/etc/nginx/sites-enabled/openclaw
# 更新时间：2026-02-13
#
# 架构变更：
#   v1 (legacy): iOS App -> Nginx -> 单一 OpenClaw Gateway (端口 18789)
#   v2 (new):    iOS App -> Nginx -> FastAPI Orchestrator (端口 8000) -> Per-user OpenClaw Container
#
# 部署步骤：
#   1. 确保 FastAPI 后端运行在 127.0.0.1:8000
#      cd /root/ClawBowl/backend && source venv/bin/activate
#      uvicorn app.main:app --host 127.0.0.1 --port 8000
#   2. 复制此文件到 /etc/nginx/sites-enabled/openclaw
#   3. nginx -t && nginx -s reload

# 以下为实际部署在服务器上的 location 块（位于 server { ... } 内）

# ── 静态页面 ──────────────────────────────────────────────

# 隐私政策页面（App Store 必需）
location /privacy-policy {
    alias /var/www/clawbowl/privacy-policy.html;
    default_type text/html;
}

# 技术支持页面（App Store 必需）
location /support {
    alias /var/www/clawbowl/support.html;
    default_type text/html;
}

# ── v2 API: Orchestrator 多租户路由 ──────────────────────

location /api/v2/ {
    proxy_pass http://127.0.0.1:8000/api/v2/;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # AI 回复可能需要较长时间（与后端 httpx 300s / 前端 URLSession 300s 对齐）
    proxy_connect_timeout 10s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # 请求体大小限制
    client_max_body_size 100m;
}

# Orchestrator 健康检查
location = /healthz {
    proxy_pass http://127.0.0.1:8000/healthz;
    proxy_http_version 1.1;
}

# ── v1 API: Legacy 单实例路由（兼容期，逐步废弃）────────

location /api/chat {
    # 仅允许 POST 请求
    if ($request_method != POST) {
        return 405;
    }

    # 转发到 OpenClaw Gateway（端口 18789）
    proxy_pass http://127.0.0.1:18789/v1/chat/completions;
    proxy_http_version 1.1;

    # 自动注入认证头（客户端无需携带 token）
    proxy_set_header Authorization "Bearer <token-on-server>";
    proxy_set_header Content-Type "application/json";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 超时设置（AI 回复可能需要较长时间）
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # 请求体大小限制
    client_max_body_size 100m;
}
